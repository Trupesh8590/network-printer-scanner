<!DOCTYPE html>
<html>
<head>
  <title>Printer Scanner & PDF Sender</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    button {
      padding: 12px 24px;
      background-color: #007AFF;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      margin: 10px 0;
      cursor: pointer;
    }
    #status {
      padding: 15px;
      background-color: #F2F2F7;
      border-radius: 8px;
      margin: 15px 0;
    }
    .printer {
      padding: 15px;
      margin: 10px 0;
      background-color: #FFFFFF;
      border: 1px solid #D1D1D6;
      border-radius: 8px;
    }
    input[type="file"] {
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>Printer Scanner + PDF Upload</h1>
  <button id="scanBtn">Start Scan</button>
  <div id="status">Ready to scan...</div>
  <div id="results"></div>

  <script>
    let selectedPrinterIP = '';

    document.getElementById('scanBtn').addEventListener('click', async function() {
      const statusEl = document.getElementById('status');
      const resultsEl = document.getElementById('results');
      resultsEl.innerHTML = '';
      selectedPrinterIP = '';
      statusEl.innerHTML = 'Scanning network... (Please wait)';

      let subnet = await getLocalSubnet();
      let scannedRanges = [];

      if (subnet) scannedRanges.push(subnet);
      scannedRanges.push("192.168.0", "192.168.1");

      for (let net of scannedRanges) {
        for (let i = 1; i <= 20; i++) {
          const ip = `${net}.${i}`;
          statusEl.innerHTML = `Checking ${ip}...`;

          try {
            const isPrinter = await checkPrinter(ip);
            if (isPrinter) {
              resultsEl.innerHTML += `
                <div class="printer">
                  <strong>Printer Detected</strong><br>
                  IP: ${ip}<br>
                  <button onclick="selectPrinter('${ip}')">Connect</button>
                  <button onclick="window.open('http://${ip}', '_blank')">Open Web Interface</button>
                </div>
              `;
            }
          } catch (e) {
            console.log(`Error checking ${ip}:`, e);
          }

          await new Promise(resolve => setTimeout(resolve, 150));
        }
      }

      const found = document.querySelectorAll('.printer').length;
      statusEl.innerHTML = found
        ? `✅ Scan complete. Found ${found} printer(s).`
        : '❌ No printers found. Please ensure Wi-Fi is connected.';
    });

    function selectPrinter(ip) {
      selectedPrinterIP = ip;
      const resultsEl = document.getElementById('results');
      resultsEl.innerHTML = `
        <h3>Connected to Printer at ${ip}</h3>
        <input type="file" id="pdfFile" accept="application/pdf"><br>
        <button onclick="sendToPrinter()">Print PDF</button>
        <br><br>
        <button onclick="window.open('http://${ip}', '_blank')">Open Web Interface</button>
      `;
      document.getElementById('status').innerText = `Connected to ${ip}`;
    }

    function sendToPrinter() {
      const fileInput = document.getElementById('pdfFile');
      const file = fileInput.files[0];
      if (!file || !selectedPrinterIP) {
        alert("Please connect and upload a PDF first.");
        return;
      }

      const reader = new FileReader();
      reader.onload = function() {
        fetch(`http://${selectedPrinterIP}/`, {
          method: 'POST',
          body: reader.result,
          headers: {
            'Content-Type': 'application/pdf'
          }
        }).then(res => {
          alert("Sent to printer. Please check print output.");
        }).catch(err => {
          alert("Failed to send PDF. Make sure printer is on and supports raw PDF printing.");
        });
      };
      reader.readAsArrayBuffer(file);
    }

    async function getLocalSubnet() {
      return new Promise(resolve => {
        try {
          const pc = new RTCPeerConnection({iceServers:[]});
          pc.createDataChannel('');
          pc.createOffer().then(offer => pc.setLocalDescription(offer));
          pc.onicecandidate = e => {
            if (e.candidate) {
              const ip = e.candidate.candidate.split(' ')[4];
              pc.close();
              resolve(ip.split('.').slice(0, 3).join('.'));
            }
          };
          setTimeout(() => resolve(null), 1500);
        } catch (e) {
          resolve(null);
        }
      });
    }

    async function checkPrinter(ip) {
      return new Promise(resolve => {
        const img = new Image();
        img.onload = () => resolve(true);
        img.onerror = () => {
          const img2 = new Image();
          img2.onload = () => resolve(true);
          img2.onerror = () => resolve(false);
          img2.src = `http://${ip}:631/favicon.ico?${Date.now()}`;
        };
        img.src = `http://${ip}/favicon.ico?${Date.now()}`;
        setTimeout(() => resolve(false), 1200);
      });
    }
  </script>
</body>
</html>